#!/usr/bin/env bash

# Remove old containers
docker container rm \
  lpwanserver_dev_e2e_test \
  lpwanserver_dev_prisma \
  lpwanserver_dev_postgres \
  lpwanserver_dev_loraserver2 \
  lpwanserver_dev_loraserver1 \
  lpwanserver_dev_loraappserver2 \
  lpwanserver_dev_loraappserver1 \
  lpwanserver_dev_loraserver_postgres \
  lpwanserver_dev_loraserver_redis \
  lpwanserver_dev_loraserver_mosquitto --force

# Remove old volumes
docker volume rm \
  lpwanserver_dev_postgres \
  lpwanserver_dev_loraserver_postgres --force

# Start Prisma
docker-compose -f ./prisma/dev/docker-compose.yml up -d

sleep 5s

# Deploy Prisma datamodel
npm run prisma:dev deploy

# npm run package-test
node bin/test/package-e2e.js

# Run docker-compose with development configuration
docker-compose \
  -f ./docker/dev/loraserver/docker-compose.yml \
  -f ./docker/test/e2e/docker-compose.yml up \
  --abort-on-container-exit
  --exit-code-from e2e-test

# Stop Prisma
docker-compose -f ./prisma/dev/docker-compose.yml down
