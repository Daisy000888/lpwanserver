#!/usr/bin/env bash

export prisma_protocol=http
export prisma_host=localhost
export prisma_port=4466

# Remove old containers
docker container rm \
  lpwanserver_dev_unit_test \
  lpwanserver_dev_prisma \
  lpwanserver_dev_postgres --force

docker volume rm \
  lpwanserver_dev_postgres \
  lpwanserver_dev_redis --force

# Start databases and prisma
docker-compose -f ./docker/dev/databases/docker-compose.yml up -d

sleep 5s

# Deploy prisma
npm run prisma:dev deploy

sleep 5s

# npm run package-test
node ./bin/test/package-unit.js

# Run docker-compose with development configuration
docker-compose \
  -f ./docker/test/unit/docker-compose.yml up \
  --abort-on-container-exit \
  --exit-code-from unit-test

TEST_EXIT_CODE=$?

# Stop databases
docker-compose -f ./docker/dev/databases/docker-compose.yml down

# Exit script with the code from the test
exit $TEST_EXIT_CODE
